# docker

**tag:** #linux #linux/docker

`vi /etc/docker/daemon.json`

## 安装

> 以[docker官方为准](https://docs.docker.com/engine/install/)

```shell
yum install yum-utils device-mapper-persistent-data lvm2
yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
yum install docker-ce docker-ce-cli containerd.io
```

## 更改路径

```shell
mv /var/lib/docker/* /home/docker
cp /var/lib/docker/* /home/docker
mount --bind /home/docker /var/lib/docker
```

## docker远程访问端口

对于`openrc`
![开启docker远程访问管理](./../00-发行版本操作/Alpine.md#开启docker远程访问管理)
## 开机启动

```shell
vi /etc/rc.d/init.d/mountdocker

#!/bin/sh
#chkconfig: - 85 15
#description: mount docker store
mount --bind /home/docker /var/lib/docker
```

### 设置为任务

```shell
chkconfig --add /etc/init.d/mountdocker
chkconfig mountdocker on
service mountdocker start
```

## docker更新

```shell
docker container update --restart=always 容器名称
```


## docker配置文件

### 一般
```shell
vim /etc/docker/daemon.json
{
 "registry-mirrors":["https://hub-mirror.c.163.com/"],
 "hosts":["unix:///var/run/docker.sock", "tcp://192.168.59.3:2376"],
 "data-root": "/opt/docker/docker"
}
vim /etc/containerd/config.toml
```

### 说明
```json
{
    "authorization-plugins": [],
    "registry-mirrors":["https://hub-mirror.c.163.com/"], //镜像加速的地址，增加后在 docker info中可查看。
    "seccomp-profile": "",
    "insecure-registries":["194.0.19.247:5000"],    //配置docker的私库地址
    "data-root": "/opt/docker/docker", // Docker运行时使用的根路径,根路径下的内容稍后介绍，默认/var/lib/docker
    "hosts": ["unix:///var/run/docker.sock", "tcp://192.168.59.3:2376"],  //设置容器hosts
    // You cannot set options in daemon.json that have already been set on daemon startup as a flag. On systems that use systemd to start the Docker daemon, -H is already set, so you cannot use the hosts key in daemon.json to add listening addresses. See https://docs.docker.com/engine/admin/systemd/#custom-docker-daemon-options for how to accomplish this task with a systemd drop-in file.


    "storage-driver": "",
    "dns": [], 
     #设定容器DNS的地址，在容器的 /etc/resolv.conf文件中可查看
    "dns-opts": [],
     #容器 /etc/resolv.conf 文件，其他设置
    "dns-search": [],
     #设定容器的搜索域，当设定搜索域为 .example.com 时，在搜索一个名为 host 的 主机时，DNS不仅搜索host，还会搜索host.example.com。注意：如果不设置，Docker 会默认用主机上的 /etc/resolv.conf来配置容器。
    "exec-opts": [],
    "exec-root": "",
    "experimental": false,
    "features": {},
    "storage-opts": [],
    "labels": [],
     #docker主机的标签，很实用的功能,例如定义：–label nodeName=host-121
    "live-restore": true,
    "log-driver": "",
    "log-opts": {},
    "mtu": 0,
    "pidfile": "",
     #Docker守护进程的PID文件
    "cluster-store": "",
    "cluster-store-opts": {},
    "cluster-advertise": "",
    "max-concurrent-downloads": 3,
    "max-concurrent-uploads": 5,
    "default-shm-size": "64M",
    "shutdown-timeout": 15,
    "debug": true,
     #启用debug的模式，启用后，可以看到很多的启动信息。默认false
    "log-level": "",
    "tls": true, 
     #默认 false, 启动TLS认证开关
    "tlscacert": "",
     #默认 ~/.docker/ca.pem，通过CA认证过的的certificate文件路径
    "tlscert": "",
     #默认 ~/.docker/cert.pem ，TLS的certificate文件路径
    "tlskey": "",
     #默认~/.docker/key.pem，TLS的key文件路径
    "tlsverify": true,
     #默认false，使用TLS并做后台进程与客户端通讯的验证
    "tls": true,
    "tlsverify": true,
    "tlscacert": "",
    "tlscert": "",
    "tlskey": "",
    "swarm-default-advertise-addr": "",
    "api-cors-header": "",
    "selinux-enabled": false,
     #默认 false，启用selinux支持
    "userns-remap": "",
    "group": "",
     #Unix套接字的属组,仅指/var/run/docker.sock
    "cgroup-parent": "",
    "default-ulimits": {
        "nofile": {
            "Name": "nofile",
            "Hard": 64000,
            "Soft": 64000
        }
    },
    "init": false,
    "init-path": "/usr/libexec/docker-init",
    "ipv6": false,
    "iptables": false,
    "ip-forward": false,
    #默认true, 启用 net.ipv4.ip_forward ,进入容器后使用sysctl -a|grepnet.ipv4.ip_forward查看
    "ip-masq": false,
    "userland-proxy": false,
    "userland-proxy-path": "/usr/libexec/docker-proxy",
    "ip": "0.0.0.0",
    "bridge": "",
    "bip": "",
    "fixed-cidr": "",
    "fixed-cidr-v6": "",
    "default-gateway": "",
    "default-gateway-v6": "",
    "icc": false,
    "raw-logs": false,
    "allow-nondistributable-artifacts": [],

    "no-new-privileges": false,
    "default-runtime": "runc",
    "oom-score-adjust": -500,
    "node-generic-resources": ["NVIDIA-GPU=UUID1", "NVIDIA-GPU=UUID2"],
    "runtimes": {
        "cc-runtime": {
            "path": "/usr/bin/cc-runtime"
        },
        "custom": {
            "path": "/usr/local/bin/my-runc-replacement",
            "runtimeArgs": [
                "--debug"
            ]
        }
    },
    "default-address-pools":[{"base":"172.80.0.0/16","size":24},
    {"base":"172.90.0.0/16","size":24}]
}
```