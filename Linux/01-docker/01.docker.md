# docker

**tag:** #linux #linux/docker

`vi /etc/docker/daemon.json`

## 安装

> 以[docker官方为准](https://docs.docker.com/engine/install/)

```shell
yum install yum-utils device-mapper-persistent-data lvm2
yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
yum install docker-ce docker-ce-cli containerd.io
```

## 更改路径

```shell
mv /var/lib/docker/* /home/docker
cp /var/lib/docker/* /home/docker
mount --bind /home/docker /var/lib/docker
```

## docker远程访问端口

对于`openrc`
![开启docker远程访问管理](./../00-发行版本操作/Alpine.md#开启docker远程访问管理)
## 开机启动

```shell
vi /etc/rc.d/init.d/mountdocker

#!/bin/sh
#chkconfig: - 85 15
#description: mount docker store
mount --bind /home/docker /var/lib/docker
```

### 设置为任务

```shell
chkconfig --add /etc/init.d/mountdocker
chkconfig mountdocker on
service mountdocker start
```

## docker更新

```shell
docker container update --restart=always 容器名称
```


## docker配置文件

### 一般
```shell
vim /etc/docker/daemon.json
{
 "registry-mirrors":["https://hub-mirror.c.163.com/"],
 "hosts":["unix:///var/run/docker.sock", "tcp://192.168.59.3:2376"],
 "data-root": "/opt/docker/docker"
}
vim /etc/containerd/config.toml
```

### 说明
```json
{
    "authorization-plugins": [],
    "registry-mirrors":["https://hub-mirror.c.163.com/"], //镜像加速的地址，增加后在 docker info中可查看。
    "seccomp-profile": "",
    "insecure-registries":["194.0.19.247:5000"],    //配置docker的私库地址
    "data-root": "/opt/docker/docker", // Docker运行时使用的根路径,根路径下的内容稍后介绍，默认/var/lib/docker
    "hosts": ["unix:///var/run/docker.sock", "tcp://192.168.59.3:2376"],  //设置容器hosts
    // You cannot set options in daemon.json that have already been set on daemon startup as a flag. On systems that use systemd to start the Docker daemon, -H is already set, so you cannot use the hosts key in daemon.json to add listening addresses. See https://docs.docker.com/engine/admin/systemd/#custom-docker-daemon-options for how to accomplish this task with a systemd drop-in file.


    "storage-driver": "",
    "dns": [], 
     #设定容器DNS的地址，在容器的 /etc/resolv.conf文件中可查看
    "dns-opts": [],
     #容器 /etc/resolv.conf 文件，其他设置
    "dns-search": [],
     #设定容器的搜索域，当设定搜索域为 .example.com 时，在搜索一个名为 host 的 主机时，DNS不仅搜索host，还会搜索host.example.com。注意：如果不设置，Docker 会默认用主机上的 /etc/resolv.conf来配置容器。
    "exec-opts": [],
    "exec-root": "",
    "experimental": false,
    "features": {},
    "storage-opts": [],
    "labels": [],
     #docker主机的标签，很实用的功能,例如定义：–label nodeName=host-121
    "live-restore": true,
    "log-driver": "",
    "log-opts": {},
    "mtu": 0,
    "pidfile": "",
     #Docker守护进程的PID文件
    "cluster-store": "",
    "cluster-store-opts": {},
    "cluster-advertise": "",
    "max-concurrent-downloads": 3,
    "max-concurrent-uploads": 5,
    "default-shm-size": "64M",
    "shutdown-timeout": 15,
    "debug": true,
     #启用debug的模式，启用后，可以看到很多的启动信息。默认false
    "log-level": "",
    "tls": true, 
     #默认 false, 启动TLS认证开关
    "tlscacert": "",
     #默认 ~/.docker/ca.pem，通过CA认证过的的certificate文件路径
    "tlscert": "",
     #默认 ~/.docker/cert.pem ，TLS的certificate文件路径
    "tlskey": "",
     #默认~/.docker/key.pem，TLS的key文件路径
    "tlsverify": true,
     #默认false，使用TLS并做后台进程与客户端通讯的验证
    "tls": true,
    "tlsverify": true,
    "tlscacert": "",
    "tlscert": "",
    "tlskey": "",
    "swarm-default-advertise-addr": "",
    "api-cors-header": "",
    "selinux-enabled": false,
     #默认 false，启用selinux支持
    "userns-remap": "",
    "group": "",
     #Unix套接字的属组,仅指/var/run/docker.sock
    "cgroup-parent": "",
    "default-ulimits": {
        "nofile": {
            "Name": "nofile",
            "Hard": 64000,
            "Soft": 64000
        }
    },
    "init": false,
    "init-path": "/usr/libexec/docker-init",
    "ipv6": false,
    "iptables": false,
    "ip-forward": false,
    #默认true, 启用 net.ipv4.ip_forward ,进入容器后使用sysctl -a|grepnet.ipv4.ip_forward查看
    "ip-masq": false,
    "userland-proxy": false,
    "userland-proxy-path": "/usr/libexec/docker-proxy",
    "ip": "0.0.0.0",
    "bridge": "",
    "bip": "",
    "fixed-cidr": "",
    "fixed-cidr-v6": "",
    "default-gateway": "",
    "default-gateway-v6": "",
    "icc": false,
    "raw-logs": false,
    "allow-nondistributable-artifacts": [],

    "no-new-privileges": false,
    "default-runtime": "runc",
    "oom-score-adjust": -500,
    "node-generic-resources": ["NVIDIA-GPU=UUID1", "NVIDIA-GPU=UUID2"],
    "runtimes": {
        "cc-runtime": {
            "path": "/usr/bin/cc-runtime"
        },
        "custom": {
            "path": "/usr/local/bin/my-runc-replacement",
            "runtimeArgs": [
                "--debug"
            ]
        }
    },
    "default-address-pools":[{"base":"172.80.0.0/16","size":24},
    {"base":"172.90.0.0/16","size":24}]
}
```



## containerd

顶级配置块下面的子配置块表示该插件的各种配置，比如 cri 插件下面就分为 containerd、cni 和 registry 的配置，而 containerd 下面又可以配置各种 runtime，还可以配置默认的 runtime。比如现在我们要为镜像配置一个加速器，那么就需要在 cri 配置块下面的 `registry` 配置块下面进行配置 `registry.mirrors`：
```toml
[plugins."io.containerd.grpc.v1.cri".registry]  
  [plugins."io.containerd.grpc.v1.cri".registry.mirrors]  
    [plugins."io.containerd.grpc.v1.cri".registry.mirrors."docker.io"]  
      endpoint = ["https://bqr1dr1n.mirror.aliyuncs.com"]  
    [plugins."io.containerd.grpc.v1.cri".registry.mirrors."k8s.gcr.io"]  
      endpoint = ["https://registry.aliyuncs.com/k8sxio"]  
```

-   `registry.mirrors."xxx"`: 表示需要配置 mirror 的镜像仓库，例如 `registry.mirrors."docker.io"` 表示配置 docker.io 的 mirror。
-   `endpoint`: 表示提供 mirror 的镜像加速服务，比如我们可以注册一个阿里云的镜像服务来作为 docker.io 的 mirror。


### ctr
拉取镜像可以使用 `ctr image pull` 来完成，比如拉取 Docker Hub 官方镜像 `nginx:alpine`，需要注意的是镜像地址需要加上 `docker.io` Host 地址：

`ctr image pull docker.io/library/nginx:alpine`

也可以使用 `--platform` 选项指定对应平台的镜像。当然对应的也有推送镜像的命令 `ctr image push`，如果是私有镜像则在推送的时候可以通过 `--user` 来自定义仓库的用户名和密码。


```shell
ctr image ls
ctr image ls -q
ctr image check
ctr image tag docker.io/library/nginx:alpine harbor.k8s.local/course/nginx:alpine #g给镜像重命名
ctr image rm harbor.k8s.local/course/nginx:alpine
ctr image mount docker.io/library/nginx:alpine /mnt # 挂载镜像
ctr image unmount /mnt
ctr image export nginx.tar.gz docker.io/library/nginx:alpine
ctr container info nginx
ctr container rm nginx
# 启动容器
ctr task start -d nginx
ctr task ls
ctr task metrics nginx
ctr task exec --exec-id 0 -t nginx sh # 不过这里需要注意必须要指定 `--exec-id` 参数，这个 id 可以随便写，只要唯一就行。
ctr task pause nginx
ctr task resume nginx
ctr task kill nginx
ctr task rm nginx
ctr task ps nginx

# 命名空间
ctr ns ls
ctr ns create test
ctr ns ls
ctr ns rm test
ctr -n test image ls
```

### 使用第三方管理工具
https://www.cnblogs.com/cgqplus/p/14689600.html
https://www.cnblogs.com/cgqplus/p/14689600.html

## 创建持续可用的镜像

```bash
docker run -d -p 9000:9000 \
--restart=always \
-v /var/run/docker.sock:/var/run/docker.sock \
--name prtainer-ce \
portainer/portainer



docker run -itd \
--name alpine-go \
--restart=always \
-p 18500-18530:18500-18530 \
-v /opt/docker-u/:/opt/docker-u/ \
--entrypoint "/opt/docker-u/star.sh" \
docker.io/alpine 

-i 表示 interactive 可交互的，变即可以从标准输入与容器交互。
-t 表示给容器分配一个虚拟终端。
-d 这个参数表示的是在后台运行，即 –deamon。
```

```bash
#!/bin/sh
# apk add  openssh-server
# ssh-keygen -A


/usr/sbin/sshd -p 18500
echo '000' >> /test.log
# exit 0

while true
do
  sleep 1000
done
```
```
