# IPVS

1. 加载模块

```shell
# 临时生效
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack_ipv4
 
# 永久生效
cat > /etc/sysconfig/modules/ipvs.modules <<EOF
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack_ipv4
```

```conf
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
```

2. 设置虚拟ip(==vip==)

- 关闭`NetworkManager`: `systemctl disable NetworkManager && systemctl stop NetworkManager`
- 将主控机的`eth0`网卡加入`eth0:1`,ip地址为:==192.168.2.250==
- 将真实服务器的`lo`网卡加入`lo:1`,ip地址为:==192.168.2.250==, 与上面相同, `ifup lo`

```conf
# 主控
BOOTPROTO=static
DEVICE=eth0:1
ONBOOT=1
IPADDR=192.168.2.25
NETMASK=255.255.255.0

# 被控
DEVICE=lo:1
IPADDR=192.168.2.25
NETMASK=255.255.255.255
NETWORK=127.0.0.0
```

3. arp请求

- `arp-ignore` 有0-8种模式,但2-8用的很少
> ==0==: 只要配置IP, 就相应亲求 <br />
> ==1==: 请求目标到达相应网络接口,才相应请求

- `arp-announce`: arp通报行为
> ==0==: 任何接口都向外通报 <br />
> ==1==: 尽可能避免本网卡与不匹配目标通报 <br />
> ==2==: 只在本网卡经行通报


```sysctl.conf
# /etc/sysctl.conf
net.ipv4.conf.all.arp_ignore=1
net.ipv4.conf.defult.arp_ignore=1
net.ipv4.conf.lo.arp_ignore=1
net.ipv4.conf.all.arp_announce=2
net.ipv4.conf.defult.arp_announce=2
net.ipv4.conf.lo.arp_announce=2
```

4. 在被控的真实服务器中配置路由

```shell
route add -host 192.168.2.250 dev lo:1
```


### ipvsadm

```shell
# 添加一个集群服务器
ipvsadm -A -t 192.168.2.250:80 -s rr
# 给该集群添加一个节点 -g的意思为--gatewaying (direct routing)
ipvsadm -a -t 192.168.2.250:80 -r 192.168.2.21:80 -g
# 编辑节点, 使他的数据持久化变为5秒
ipvsadm -E -t 192.168.2.250:80 -s rr -p 5
# 设置 tcp tcpfin udp 超时时间
ipvsadm --set 2 2 2 
```



---