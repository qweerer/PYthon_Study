# 09-各种代理

#linux 

## ss

```json
{
    "server":"0.0.0.0",
    "mode":"tcp",
    "server_port":111,
    "local_port":1080,
    "port_password":{
		"8388":"password1",
 		"8389":"password2",
 },
    "timeout":300,
    "method":"aes-256-cfb"
}

```


## go-proxy
[ snail007/goproxy · GitHub](https://github.com/snail007/goproxy/blob/master/README_ZH.md)
- 手动

```shell
rm /usr/bin/proxy && rm -rf /etc/proxy
tar -xf proxy-linux-arm64-v8.tar.gz
mkdir /etc/proxy
cp blocked /etc/proxy
cp direct  /etc/proxy
cd /etc/proxy/
/opt/03-goproxy/proxy keygen -C proxy
```

- 自动

```shell
cd /root/proxy/  
wget https://mirrors.host900.com/https://github.com/snail007/goproxy/releases/download/v10.4/proxy-linux-amd64.tar.gz
cd /root/proxy/  
wget https://mirrors.host900.com/https://raw.githubusercontent.com/snail007/goproxy/master/install.sh  
chmod +x install.sh  
./install.sh
```

### 生成加密通讯需要的证书文件

http(s)代理、tcp代理、udp代理、socks5代理、内网穿透等功能和上级通讯的时候，为了安全我们采用TLS加密通讯，当然可以选择不加密通信通讯，本教程所有和上级通讯都采用加密，需要证书文件。

_**所有端必须使用相同的proxy.crt和proxy.key**_

1.通过下面的命令生成自签名的证书和key文件。  
`proxy keygen -C proxy`  
会在当前程序目录下面生成证书文件proxy.crt和key文件proxy.key。

2.通过下面的命令生，使用自签名证书proxy.crt和key文件proxy.key签发新证书:goproxy.crt和goproxy.key。  
`proxy keygen -s -C proxy -c goproxy` 
会在当前程序目录下面生成证书文件goproxy.crt和key文件goproxy.key。

3.默认情况下证书的里面的域名是随机的，可以使用`-n test.com`参数指定。

4.更多用法:`proxy keygen --help`。

### 8. 安全建议

当VPS在nat设备后面，vps上网卡IP都是内网IP，这个时候可以通过-g参数添加vps的外网ip防止死循环。

假设你的vps外网ip是23.23.23.23，下面命令通过-g参数设置23.23.23.23

`proxy http -g "23.23.23.23"`

### 12. 客户端IP黑白名单

socks/http(s)/sps/tcp/udp/dns/内网穿透bridge/内网穿透tbridge，都支持客户端IP黑白名单。

用--ip-deny参数指定一个客户端IP黑名单列表文件，那么当用户的IP在这个文件里面的时候连接就会被断开。

用--ip-allow参数指定一个客户端IP白名单列表文件，那么当用户的IP不在这个文件里面的时候连接就会被断开。

如果同时设置了--ip-deny和--ip-allow，那么只有--ip-allow会起作用。

客户端IP黑白名单文件内容格式如下:

```
192.168.1.1  
192.168.*.*  
192.168.1?.*  
```

说明:

1.一行一个域名，域名写法支持通配符`*`和`?`，`*`代表任意个字符，`?`代表一个任意字符。

2.`#`开头的为注释

### 使用

```shell
proxy http -p ":9090" --forever --log proxy.log --daemon -g "23.23.23.23"`
```



## http代理: squid

```ssh
mkdir /opt/www/00-config/ssl/https-proxy/
openssl req -new -keyout /opt/www/00-config/ssl/https-proxy/key.pem -nodes -x509 -days 365 -out /opt/www/00-config/ssl/https-proxy/cert.pem

apk add squid mini_httpd
mini_htpasswd -c /opt/www/00-config/ssl/https-proxy/htpasswd who
vim /etc/squid/squid.conf
```

```conf
# Example rule allowing access from your local networks.
# Adapt to list your (internal) IP networks from where browsing
# should be allowed
acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122 "this" network (LAN)
# acl localnet src 10.0.0.0/8           # RFC 1918 local private network (LAN)
# acl localnet src 100.64.0.0/10          # RFC 6598 shared address space (CGN)
# acl localnet src 169.254.0.0/16         # RFC 3927 link-local (directly plugged) machines
# acl localnet src 172.16.0.0/12                # RFC 1918 local private network (LAN)
# acl localnet src 192.168.0.0/16               # RFC 1918 local private network (LAN)
# acl localnet src fc00::/7               # RFC 4193 local private network range
# acl localnet src fe80::/10              # RFC 4291 link-local (directly plugged) machines
# acl localnet src 192.168.56.0/24              # RFC 1918 local private network (LAN)



acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http

# acl test src 10.0.2.2
# http_access allow test

auth_param basic program /usr/lib/squid/basic_ncsa_auth /env/mini_passwd
auth_param basic realm Squid proxy-caching web server
auth_param basic children 5
auth_param basic credentialsttl 2 hours
acl authenticated proxy_auth REQUIRED
http_access allow authenticated
                            
# And finally deny all other access to this proxy
http_access deny all
```

## socks5代理:Dante

- socksmethod一般为username（系统用户登录） ，none（匿名登录）
- 使用username时，务必创建不能登录系统的账户通过命令`useradd`添加用户，`passwd`设置密码。权限可以为`/bin/false是最严格的禁止login选项，一切服务都不能用`与`/sbin/nologin只是不允许系统login，可以使用其他ftp等服务`

```shell
adduser --no-create-home --shell /sbin/nologin liujia2
apk add dante-server
cat /etc/sockd.conf
sockd -f conf -p pid -D
```

```conf
## general configuration (taken from FAQ; <>)

#使用端口1080

internal: eth0 port = 1080 

#使用对外网络接口   
external: eth0 

#使用的验证方式  
method: username none            （还未测试 要在后面加用户名还是不加，不加的话应该是试用系统用户）  
##user.privileged: root  
#user.notprivileged: sockd

#日志目录  
logoutput: /var/log/sockd.log       （touch一个sockd.log）

## client access rules

#client pass {  
#        from: 10.1.1.0/24 to: 0.0.0.0/0 #internal network  
#        log: connect disconnect  
#}

#允许所有的客户端连接

client pass {  
        from: 0.0.0.0/0 to:0.0.0.0/0  
        log: connect disconnect  
}

  
## server operation access rules

#allow bind to ports greater than 1023  
#pass {  
#        from: 0.0.0.0/0 to: 0.0.0.0/0 port gt 1023  
#        command: bind  
#        log: connect disconnect  
#}

#allow outgoing connections (tcp and udp)  
pass {  
        from: 0.0.0.0/0 to: 0.0.0.0/0  
        command: connect udpassociate  
        log: connect disconnect  
}

#允许所有UDP代理 和 DNS解析.

#allow replies to bind, and incoming udp packets  
pass {  
       from: 0.0.0.0/0 to: 0.0.0.0/0  
       command: bindreply udpreply  
       log: connect error  
}

#log the rest  
#block {  
#       from: 0.0.0.0/0 to: 0.0.0.0/0  
#       log: connect error

```